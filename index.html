<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>TeamTap</title>

  <!-- Retro Pixel Font -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg:#0b0b14;
      --panel:#12121f;
      --ink:#e8eadf;
      --muted:#a9ad9a;
      --line:#2a2c3d;

      --OFF:#f5b301;
      --DEF:#19c37d;
      --idle:#5b6078;

      --glow-off: 0 0 18px rgba(245,179,1,.45);
      --glow-def: 0 0 18px rgba(25,195,125,.45);
    }

    *{box-sizing:border-box}
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--ink);
      font-family: 'Press Start 2P', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      image-rendering: pixelated;
    }

    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none;
      background:
        linear-gradient(rgba(255,255,255,.025), rgba(0,0,0,.05)),
        repeating-linear-gradient(0deg, rgba(0,0,0,.15) 0px, rgba(0,0,0,.15) 1px, transparent 2px, transparent 3px);
      mix-blend-mode: multiply;
    }

    .app{display:flex;flex-direction:column;min-height:100%}

    header{
      padding:12px 14px; border-bottom:2px solid var(--line);
      background: linear-gradient(180deg, #18182a, #0e0e19);
      text-shadow:0 2px 0 #000;
    }
    header h1{font-size:14px;margin:0;letter-spacing:1px}
    header .sub{color:var(--muted);font-size:10px;margin-top:6px;line-height:1.6}

    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{
      border:2px solid #3a3e55; border-radius:6px; padding:10px 12px;
      background:#2a2e44; color:#f3f4e8; cursor:pointer; font-size:10px;
      box-shadow:0 3px 0 #0a0a12, inset 0 -3px 0 rgba(0,0,0,.2);
      text-transform:uppercase; letter-spacing:.5px;
    }
    button:active{ transform:translateY(1px); box-shadow:0 2px 0 #0a0a12, inset 0 -2px 0 rgba(0,0,0,.25); }
    .ghost{ background:transparent; border-style:dashed; color:var(--muted) }

    .arena{
      flex:1; position:relative; touch-action:none; overflow:hidden;
      background:
        radial-gradient(900px 600px at 80% 0%, rgba(245,179,1,0.06), transparent 60%),
        radial-gradient(900px 800px at 0% 100%, rgba(25,195,125,0.08), transparent 60%);
    }

    .hint{
      position:absolute;left:50%;top:50%;translate:-50% -50%;text-align:center;color:var(--muted);
      padding:12px;border:2px dashed var(--line);border-radius:10px;background:rgba(10,10,20,.6);
      font-size:10px; line-height:1.8;
    }

    .banner{
      position:absolute;left:50%;top:10px;translate:-50% 0;display:flex;gap:10px;
      background:#0d0d18;border:2px solid var(--line);border-radius:10px;padding:8px 12px;font-size:10px
    }
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid rgba(255,255,255,.6)}
    .stat{font-size:10px;color:var(--muted)}

    .panel{
      border-top:2px solid var(--line);background:var(--panel);padding:12px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap
    }
    .counter{font-weight:800}

    .finger{
      position:absolute; translate:-50% -50%; width:88px; height:88px; border-radius:10px;
      display:flex; align-items:center; justify-content:center; color:#0b0b14; font-weight:900; font-size:18px;
      border:3px solid #000; outline:2px solid rgba(255,255,255,.3);
      box-shadow:0 10px 0 #000, inset 0 0 22px rgba(255,255,255,.12);
      pointer-events:auto; user-select:none; background:var(--idle);
      cursor:pointer;
    }

    .toast{
      position:fixed;left:50%;bottom:14px;translate:-50% 0;background:#0d0d18;border:2px solid var(--line);
      padding:10px 12px;border-radius:10px;color:var(--ink);font-size:10px;display:none
    }

    .badge{
      position:absolute; top:-8px; right:-8px; font-size:9px; padding:4px 6px;
      border-radius:6px; border:2px solid #000; background:#222; color:#fff;
    }
    .badge.off{ background:var(--OFF); color:#201a00; box-shadow: var(--glow-off); }
    .badge.def{ background:var(--DEF); color:#001e12; box-shadow: var(--glow-def); }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>üéÆ TeamTap v1.2</h1>
		<div class="sub">Have <b>10 players</b> place their fingers on the screen ‚Äî the system will auto-assign <b style="color:var(--OFF)">Offense</b> / <b style="color:var(--DEF)">Defense</b></div>
    <div class="controls">
      <button id="btnMode">Mode: Touch</button>
      <button id="btnAssign" class="ghost" style="display:none;">Assign Teams</button>
      <button id="btnClear">Clear</button>
      <div id="devControls" style="display:none;">
        <button id="btnSim" class="ghost">Simulate 10 (Test)</button>
      </div>
    </div>
  </header>

  <div id="arena" class="arena">
    <div id="hint" class="hint">
      <b>Touch Mode:</b> Place 10 fingers at the same time.<br/>
      <b>Tap Tokens:</b> Tap 10 times to place tokens; tap a token to remove.
    </div>

    <div id="banner" class="banner" style="display:none;">
      <span><span class="dot" style="background:var(--OFF)"></span> Offense: <b id="countOff">0</b></span>
      <span><span class="dot" style="background:var(--DEF)"></span> Defense: <b id="countDef">0</b></span>
    </div>
  </div>

  <div class="panel">
    <div class="stat">Current Tokens/Fingers: <span id="count" class="counter">0</span> / 10</div>
    <div class="stat" id="status">Mode: Touch ‚Äî Waiting‚Ä¶</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
  const OFF_COL = getComputedStyle(document.documentElement).getPropertyValue('--OFF').trim() || '#f5b301';
  const DEF_COL = getComputedStyle(document.documentElement).getPropertyValue('--DEF').trim() || '#19c37d';

  const arena   = document.getElementById('arena');
  const hint    = document.getElementById('hint');
  const banner  = document.getElementById('banner');
  const countOffEl = document.getElementById('countOff');
  const countDefEl = document.getElementById('countDef');
  const countEl = document.getElementById('count');
  const statusEl= document.getElementById('status');
  const btnClear= document.getElementById('btnClear');
  const btnSim  = document.getElementById('btnSim');
  const devControls = document.getElementById('devControls');
  const btnMode = document.getElementById('btnMode');
  const btnAssign = document.getElementById('btnAssign');
  const toast   = document.getElementById('toast');

  const isDev = window.location.hostname === 'localhost' ||
    new URLSearchParams(window.location.search).get('dev') === '1';
  if(isDev){
    devControls.style.display = 'block';
    btnSim.style.display = 'inline-block';
  } else {
    btnSim.style.display = 'none';
  }

  // Mode state
  let mode = 'touch'; // 'touch' | 'tap'
  const touches = new Map(); // touchId -> rec
  let splitDone = false;
  let nextLabel = 1; // for Tap Tokens numbering

  // utils
  function getLocalXY(clientX, clientY){
    const rect = arena.getBoundingClientRect();
    return { x: clientX - rect.left, y: clientY - rect.top };
  }
  function showToast(msg, ms=1500){ toast.textContent=msg; toast.style.display='block'; clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.style.display='none', ms); }
  function shuffle(a){ const x=[...a]; for(let i=x.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]]; } return x; }

  function createFinger(x,y,label){
    const el=document.createElement('div');
    el.className='finger';
    el.style.left=x+'px'; el.style.top=y+'px';
    el.textContent=label;
    const badge=document.createElement('div');
    badge.className='badge'; badge.style.display='none';
    el.appendChild(badge);
    arena.appendChild(el);
    return { el, badge, label };
  }
  function setBadge(rec, role){
    if(!rec?.badge) return;
    if(role==='OFF'){
      rec.badge.textContent='‚öîÔ∏è';
      rec.badge.className='badge off';
      rec.badge.style.display='block';
    } else if(role==='DEF'){
      rec.badge.textContent='üõ°Ô∏è';
      rec.badge.className='badge def';
      rec.badge.style.display='block';
    } else {
      rec.badge.textContent='';
      rec.badge.className='badge';
      rec.badge.style.display='none';
    }
  }

  function updateCountUI(){
    const n = touches.size;
    countEl.textContent = n;
    hint.style.display = n===0 ? 'block':'none';
    if(mode==='touch'){
      if(n<10){ statusEl.textContent='Mode: Touch ‚Äî Waiting for 10 fingers‚Ä¶'; banner.style.display='none'; }
      else if(n===10){ statusEl.textContent = splitDone ? 'Teams assigned‚Ä¶' : '10 fingers ‚Äî assigning teams‚Ä¶'; }
      else { statusEl.textContent='Mode: Touch ‚Äî More than 10 fingers, keep only 10'; }
    } else {
      statusEl.textContent = `Mode: Tap Tokens ‚Äî Tap to add/remove (${n}/10)`;
      btnAssign.style.display = (n===10 && !splitDone) ? 'inline-block' : 'none';
      if(n<10) banner.style.display='none';
    }
  }

  function resetSplitVisuals(){
    splitDone = false;
    touches.forEach(t => { t.role=null; t.el.style.background='var(--idle)'; setBadge(t, null); });
    banner.style.display='none';
    countOffEl.textContent='0'; countDefEl.textContent='0';
  }

  function assignTeamsFrom(records){
    const order = shuffle(records);
    const OFF = order.slice(0,5);
    const DEF = order.slice(5,10);
    OFF.forEach(t => { t.role='OFF'; t.el.style.background = OFF_COL; setBadge(t,'OFF'); });
    DEF.forEach(t => { t.role='DEF'; t.el.style.background = DEF_COL; setBadge(t,'DEF'); });
    countOffEl.textContent = OFF.length;
    countDefEl.textContent = DEF.length;
    banner.style.display='flex';
    splitDone = true;
    showToast('Teams assigned: Offense / Defense');
    updateCountUI();
  }

  // ==== Touch Mode Handlers ====
  function onTouchStart(ev){
    if(mode!=='touch') return;
    ev.preventDefault();
    for(const t of ev.changedTouches){
      if(touches.size >= 10) continue;
      if(touches.has(t.identifier)) continue;
      const { x, y } = getLocalXY(t.clientX, t.clientY);
      const label = (touches.size+1);
      const rec = createFinger(x,y,label);
      touches.set(t.identifier, { ...rec, idx: label-1, role: null });
    }
    updateCountUI();
    if(touches.size===10 && !splitDone){
      assignTeamsFrom(Array.from(touches.values()));
    }
  }
  function onTouchMove(ev){
    if(mode!=='touch') return;
    ev.preventDefault();
    for(const t of ev.changedTouches){
      const rec = touches.get(t.identifier);
      if(!rec) continue;
      const { x, y } = getLocalXY(t.clientX, t.clientY);
      rec.el.style.left = x + 'px';
      rec.el.style.top  = y + 'px';
    }
  }
  function onTouchEnd(ev){
    if(mode!=='touch') return;
    ev.preventDefault();
    // Intentionally keep finger markers after touch release.
    // They remain on screen until the user presses the Clear button.
  }

  // ==== Tap Tokens Mode ====
  function onArenaClick(e){
    if(mode!=='tap') return;
    // add token if < 10
    if(touches.size >= 10){ showToast('Already 10 tokens. Tap a token to remove.'); return; }
    const { x, y } = getLocalXY(e.clientX, e.clientY);
    const rec = createFinger(x,y,nextLabel++);
    // store with a generated id
    const id = 'tap-' + Math.random().toString(36).slice(2);
    touches.set(id, { ...rec, role:null });
    // click to remove
    rec.el.addEventListener('click', (ev) => {
      if(mode!=='tap') return;
      ev.stopPropagation();
      rec.el.remove();
      // remove and re-pack labels (optional)
      touches.delete(id);
      resetSplitVisuals();
      updateCountUI();
    });
    updateCountUI();
  }

  // ==== Buttons ====
  btnClear.addEventListener('click', ()=>{
    touches.forEach(t => t.el.remove());
    touches.clear();
    nextLabel = 1;
    resetSplitVisuals();
    updateCountUI();
  });

  if(btnSim.style.display !== 'none'){
    btnSim.addEventListener('click', ()=>{
      // works for either mode: just place 10 tokens at random
      btnClear.click();
      const rect = arena.getBoundingClientRect();
      const pad = 90;
      for(let i=0;i<10;i++){
        const x = Math.random()*(rect.width-pad*2)+pad;
        const y = Math.random()*(rect.height-pad*2)+pad;
        const rec = createFinger(x,y,i+1);
        touches.set('sim'+i, { ...rec, role:null });
      }
      updateCountUI();
      if(mode==='touch'){ assignTeamsFrom(Array.from(touches.values())); }
      else { btnAssign.style.display='inline-block'; }
    });
  }

  btnMode.addEventListener('click', ()=>{
    // toggle mode
    if(mode==='touch'){
      mode='tap';
      btnMode.textContent='Mode: Tap Tokens';
      btnAssign.style.display = (touches.size===10 && !splitDone) ? 'inline-block':'none';
      statusEl.textContent='Mode: Tap Tokens ‚Äî Tap to add/remove (0/10)';
      showToast('Tap anywhere to add tokens. Tap a token to remove.');
    } else {
      mode='touch';
      btnMode.textContent='Mode: Touch';
      btnAssign.style.display='none';
      statusEl.textContent='Mode: Touch ‚Äî Waiting‚Ä¶';
      showToast('Place up to 10 fingers at once.');
    }
    // clearing is simplest to avoid mixed data
    touches.forEach(t => t.el.remove());
    touches.clear();
    nextLabel = 1;
    resetSplitVisuals();
    updateCountUI();
  });

  btnAssign.addEventListener('click', ()=>{
    if(mode!=='tap') return;
    if(touches.size !== 10){ showToast('Need exactly 10 tokens to assign.'); return; }
    if(splitDone) return;
    assignTeamsFrom(Array.from(touches.values()));
  });

  // ==== Listeners ====
  arena.addEventListener('touchstart', onTouchStart, {passive:false});
  arena.addEventListener('touchmove', onTouchMove, {passive:false});
  arena.addEventListener('touchend', onTouchEnd, {passive:false});
  arena.addEventListener('touchcancel', onTouchEnd, {passive:false});

  arena.addEventListener('click', onArenaClick);

  // resize safety for both modes
  window.addEventListener('resize', ()=>{
    const rect = arena.getBoundingClientRect();
    touches.forEach(t=>{
      const x = parseFloat(t.el.style.left); const y = parseFloat(t.el.style.top);
      if(x<0||x>rect.width||y<0||y>rect.height){
        t.el.style.left=(rect.width/2)+'px';
        t.el.style.top=(rect.height/2)+'px';
      }
    });
  });

  // init
  (function init(){
    updateCountUI();
  })();
</script>
</body>
</html>
